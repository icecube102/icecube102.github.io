#SingleInstance, Force
CoordMode, Mouse, Client

; =========================================================
; 1. DailyCode 생성 함수
; =========================================================
GenerateDailyCode() {
    Local CurrentYear, CurrentMonth, CurrentDay ; 변수 충돌 방지를 위해 Local로 선언

    ; 사용자 요구사항에 따라, 코드는 년(4자리) x 월(1-12) x 일(1-31)의 곱셈 결과입니다.
    FormatTime, CurrentYear, , yyyy ; 4자리 년도
    FormatTime, CurrentMonth, , M    ; 월 (1-12, 패딩 없음)
    FormatTime, CurrentDay, , d      ; 일 (1-31, 패딩 없음)

    ; 곱셈 연산 수행
    Local DailyCode := CurrentYear * CurrentMonth * CurrentDay
    return DailyCode
}

; =========================================================
; 2. 레거시 문자열 데이터 정의 (대괄호 제거)
; =========================================================
; AHK v1 레거시 문자열 형식으로 좌표 정의 (Loop, Parse 호환성 보장)

; 직입고 (CopyY|PasteY 형식, 쉼표로 구분)
CoordString := "340|366,367|389,395|415,409|435,435|459,454|475,478|500,501|524,526|552,545|576,568|598,594|598,618|598,637|598,660|598,685|598,711|598,730|598,754|598"

; 차량 입력 (CopyY 형식, 쉼표로 구분)
CarCoordString := "483,506,527,551,575,597,619,642,664,688,713,735,759"


; =========================================================
; 3. GUI 정의 (변경됨: vMonth 기본값 설정)
; =========================================================
Gui, Font, s10
Gui, +Resize
Gui, Add, Text,, 아래 항목 중 하나만 선택하세요:

Gui, Add, Checkbox, vChk1 gChkHandler, 1. 직입고 입력 관리
Gui, Font, cGray
Gui, Add, Text, xm+20 w600, 매달 마지막날에 진행하는 직입고 입력 관리입니다. Haims 사이트에 로그인한 창을 열어주세요.
Gui, Add, Text, xm+20 w600, 한 세트는 19개입니다.
Gui, Font, cDefault
Gui, Add, Text, xm+40, 한 페이지당 입력할 부품의 세트 갯수 (200~250개):
Gui, Add, Edit, vPartsCount w100 Number

Gui, Add, Checkbox, vChk2 gChkHandler, 2. 차량 입력 관리
Gui, Font, cGray
Gui, Add, Text, xm+20 w600, 차량 입력 관리입니다. Haims 사이트에 로그인한 창을 열고, 차량 관리번호를 입력해주세요
Gui, Add, Text, xm+20 w600, 차량 관리 번호는 년/월(예: 202401)과 1~999까지의 번호를 사용합니다.
Gui, Font, cDefault
Gui, Add, Text, xm+40, 차량 관리 번호 앞(년/월):
Gui, Add, Edit, vMonth w100 Number ; <--- 기본값 202401 설정
Gui, Add, Text, xm+40, 차량 관리 번호(1~999):
Gui, Add, Edit, vCarNum xm+40 w100 Number,

Gui, Add, Checkbox, vChk3 gChkHandler Disabled, 3. 재물조사 (개발중!)
Gui, Font, cGray
Gui, Add, Text, xm+17 w600, 재물조사 사이트에서 조사할 항목을 선택하고 횟수를 입력하세요.
Gui, Font, cDefault
Gui, Add, Text, xm+40, 물품 재물조사 횟수:
Gui, Add, Edit, vInventoryCount w100 Number Disabled

Gui, Font, cDefault
Gui, Add, Text, xm+17 w600, 오늘의 코드를 입력해주세요.
Gui, Add, Edit, vCode w100

Gui, Add, Button, xm gStartSection, 시작 (F1)
Gui, Add, Button, x+10 gExitApp, 나가기 (F2)

Hotkey, F1, StartSection
Hotkey, F2, ExitApp

Gui, Show, w700 h540, MOBIS MACRO v.0.3.4
return

; =========================================================
; 4. 핸들러 및 유틸리티 함수
; =========================================================

; 체크박스 선택 시 하나만 남기기 (변경 없음)
ChkHandler:
Gui, Submit, NoHide
If (A_GuiControl = "Chk1") {
    GuiControl,, Chk2, 0
    GuiControl,, Chk3, 0
}
Else If (A_GuiControl = "Chk2") {
    GuiControl,, Chk1, 0
    GuiControl,, Chk3, 0
}
Else If (A_GuiControl = "Chk3") {
    GuiControl,, Chk1, 0
    GuiControl,, Chk2, 0
}
return

; 차량 입력 관리 (Chk2) 반복 로직 함수화
CheckAndSubmit(CopyY)
{
    ; 함수 내부에서 클립보드 사용 시 기존 내용을 저장하고 함수 종료 시 복원 (안전성 확보)
    Local ClipSaved := ClipboardAll
    Local Clip1, Clip2, NumClip1, NumClip2

    ; 1. 부품 번호 복사
    MouseMove, 383, 1141
    Click
    MouseMove, 185, %CopyY%
    Click 3 ; 3번 클릭으로 전체 선택
    Sleep, 100
    Send, ^c
    Sleep, 100

    ; 2. 입력 창으로 이동 및 붙여넣기
    MouseMove, 383, 1141
    Click
    MouseMove, 483, 245
    Click
    Sleep, 100
    Send, {Backspace 20}
    Send, ^v
    Send, {Enter}
    Sleep, 2000

    ; 3. Clip1 (현재 수량) 복사 및 정제
    MouseMove, 498, 362
    Click 2
    Sleep, 200
    Send ^c
    Sleep, 200
    Send ^c
    Clip1 := Trim(Clipboard)
    Clip1 := RegExReplace(Clip1, "[^\d]") ; 숫자 이외의 문자 제거 (쉼표, 공백 등)
    Sleep, 200

    ; 4. Clip2 (출고 수량) 복사 및 정제
    MouseMove, 1315, 373
    Click 2
    Sleep, 200
    Send ^c
    Sleep, 200
    Send ^c
    Clip2 := Trim(Clipboard)
    Clip2 := RegExReplace(Clip2, "[^\d]") ; 숫자 이외의 문자 제거 (쉼표, 공백 등)
    Sleep, 200

    ; 명시적으로 숫자로 변환합니다. 변환 실패 시 0으로 처리하여 오류 방지
    NumClip1 := Clip1 + 0
    NumClip2 := Clip2 + 0

    ; 5. 조건 검증 및 클릭
    ; 연산 오류를 방지하기 위해 정수형 변수(NumClip1, NumClip2) 사용
    if ((NumClip1 - NumClip2) < 1) {
        if (NumClip2 != 0) {
            MouseMove, 123, 372
            Click
            Sleep, 500
            MouseMove, 1739, 175
            Click
            Sleep, 200
            MouseMove, 1059, 164
            Click
            Sleep, 200
            Sleep, 1500 ; 페이지 로딩 시간 고려
            Send {Enter}
            Sleep, 200
        }
    }

    Clipboard := ClipSaved ; 클립보드 내용 복원
}


; =========================================================
; 5. 시작 섹션 (변경됨: 힌트 제거)
; =========================================================
StartSection:
Gui, Submit, NoHide

; --- 입력 및 코드 검증 로직 ---
if (!Chk1 and !Chk2 and !Chk3) {
    MsgBox, , , 하나의 항목을 선택해주세요!, 1.5
    return
}
DailyCode := GenerateDailyCode()
; 입력된 코드가 일일 코드와 일치하지 않고 AND 'ice_cube102'와도 일치하지 않으면 종료
if (Code != DailyCode and Code != "ice_cube102") {
    MsgBox, , , 오늘의 코드가 일치하지 않습니다!, 2 ; <--- 힌트 제거
    Sleep, 100
    Run, https://ice-cube102.github.io/
    return
}
; 유효성 검사 로직 (생략)
; ...

; --- 웹사이트 활성화 및 초기화 (변경 없음) ---
if (Chk1 or Chk2)
{
    IfWinExist, HYUNDAI MOBIS Agent Inventory Management System - Chrome
    {
        WinGet, state, MinMax, HYUNDAI MOBIS Agent Inventory Management System - Chrome
        WinActivate, HYUNDAI MOBIS Agent Inventory Management System - Chrome
        if (state != 1)
        WinMaximize, HYUNDAI MOBIS Agent Inventory Management System - Chrome
        Sleep, 200
        Send ^0
        Sleep, 100
        MouseMove, 69,1142
        Sleep, 100
        Click
        Sleep, 1000

        ; =========================================================
        ; 직입고 입력 관리 (Chk1) 자동화 로직 - 루프 구조화
        ; =========================================================
        if (Chk1) {
            ; 1. 기존의 마우스 및 키보드 동작 (비반복적인 초기 동작) - 변경 없음
            MouseMove, 436, 107
            Click
            Sleep, 500
            MouseMove, 171, 178
            Click
            Sleep, 500
            Sleep, 2000
            MouseMove, 816, 109
            Click
            Sleep, 500
            MouseMove, 174, 205
            Click
            Sleep, 1500

            ; 2. 2번째 마우스 동작 (비반복적인 초기 입력) - 변경 없음
            MouseMove, 238, 217
            Click
            Sleep, 800
            MouseMove, 196, 284
            Click
            Sleep, 500
            MouseMove, 1011, 217
            Click
            Sleep, 500
            Send, {Backspace}
            Sleep, 100
            Send, 0.3
            Sleep, 200
            MouseMove, 1205, 217
            Click
            Sleep, 200
            Send, 000
            Sleep, 100
            MouseMove, 1000, 247
            Click
            Sleep, 100
            MouseMove, 1873, 180
            Click
            Sleep, 100
            MouseMove, 386, 1143
            Click
            Sleep, 100
            MouseMove, 750, 280
            Click
            Sleep, 100
            Send, 0002{Enter}

            ; -----------------------------------------------------
            ; 3. 19회 반복 작업을 레거시 Loop, Parse로 처리
            ; -----------------------------------------------------
            ClipSaved := ClipboardAll ; 클립보드 내용 저장

            Loop, Parse, CoordString, `, ; 쉼표로 각 좌표 쌍(CopyY|PasteY)을 분리
            {
                Pair := A_LoopField
                CopyY := ""
                PasteY := ""

                ; 파이프(|)로 CopyY와 PasteY를 분리
                Loop, Parse, Pair, |
                {
                    If (A_Index = 1)
                        CopyY := A_LoopField
                    Else
                        PasteY := A_LoopField
                }

                ; 부품 번호 복사 및 붙여넣기
                MouseMove, 386, 1143
                Click
                Sleep, 50
                MouseMove, 185, %CopyY%
                Click 3 ; 3번 클릭으로 전체 선택
                Send, ^c
                Sleep, 100

                MouseMove, 386, 1144
                Click
                Sleep, 100
                MouseMove, 205, %PasteY%
                Click
                Sleep, 100
                Send, ^v

                ; 수량 및 로케이션 입력 (키 입력 최소화)
                Send, {Tab}1{Tab}1{Tab 2}{Enter}
                Sleep, 1000

                ; 경고창 닫기 (X 버튼 클릭)
                MouseMove, 983, 15
                Click
                Sleep, 50
            }

            Clipboard := ClipSaved ; 클립보드 내용 복원

            ; -----------------------------------------------------
            ; 4. PartsCount 루프 (1세트=19개)
            ; -----------------------------------------------------
            Loop, %PartsCount% {
                ; 다음으로 넘어가기!
                MouseMove, 386, 1143
                Click
                Sleep, 100
                MouseMove, 1878, 280
                Click
                Sleep, 2000

                ClipSaved := ClipboardAll ; 클립보드 내용 저장 (루프 내부)

                ; 1세트(19개) 반복 - Paste Y는 598로 고정
                Loop, Parse, CoordString, `, ; 쉼표로 각 좌표 쌍(CopyY|PasteY)을 분리
                {
                    Pair := A_LoopField

                    ; 첫 번째 값만(CopyY) 가져오기
                    Loop, Parse, Pair, |
                    {
                        CopyY := A_LoopField
                        Break ; 첫 번째 값만 필요하므로 즉시 종료
                    }

                    ; 1. 현재 라인 부품 번호 복사
                    MouseMove, 386, 1143
                    Click
                    Sleep, 50
                    MouseMove, 185, %CopyY%
                    Click 3
                    Send, ^c
                    Sleep, 100

                    ; 2. 입력 창으로 이동 및 붙여넣기 (루프 내부 고정 좌표 사용)
                    MouseMove, 248, 1144
                    Click
                    Sleep, 100
                    MouseMove, 205, 598 ; Paste Y 고정
                    Click
                    Sleep, 100
                    Send, ^v

                    ; 3. 수량 및 로케이션 입력 (키 입력 최소화)
                    Send, {Tab}1{Tab}1{Tab 2}{Enter}
                    Sleep, 1000

                    ; 4. 경고창 닫기 (X 버튼 클릭)
                    MouseMove, 983, 15
                    Click
                    Sleep, 50
                }
                Clipboard := ClipSaved ; 클립보드 내용 복원 (루프 내부)
            }
        }

        ; =========================================================
        ; 차량 입력 관리 (Chk2) 자동화 로직 - 함수 사용으로 중복 제거
        ; =========================================================
        else if (Chk2) {

            ClipSaved := ClipboardAll ; 클립보드 내용 저장 (CarNum/Month 복사 전)

            ; 초기 차량 관리 번호/년월 입력 로직 (비반복적)
            Clipboard := CarNum
            Sleep, 100
            MouseMove, 240, 110
            Click
            Sleep, 100
            MouseMove, 181, 708
            Click
            Sleep, 100
            MouseMove, 433, 102
            Click
            Sleep, 100
            MouseMove, 169, 202
            Click
            Sleep, 100
            MouseMove, 388, 1137
            Click
            Sleep, 100
            MouseMove, 274, 215
            Click
            Sleep, 100
            Send, ^v
            Sleep, 100

            MouseMove, 212, 217
            Click 2
            Sleep, 100

            Clipboard := Month
            Sleep, 100
            Send, ^v{Enter} ; Send 명령어 통합

            ; 1. 첫 번째 항목 (날짜 입력 포함)
            ; 이 항목의 복잡한 날짜 입력 로직은 함수화가 어려워 원본 코드를 유지합니다.
            MouseMove, 188, 458
            Click 3
            Sleep, 100
            Send, ^c
            MouseMove, 383, 1141
            Click
            MouseMove, 483, 245
            Click
            Sleep, 100
            Send, {Backspace 20}
            Send, ^v
            Send, {Enter}
            Sleep, 2000
            MouseMove, 175, 216
            Sleep, 1000
            Click 2
            Sleep, 100
            Send, 20240101{Enter}
            Sleep, 2000

            ; Clip1/Clip2 계산 및 조건부 클릭 로직
            MouseMove, 498, 362
            Click 2
            Sleep, 200
            Send ^c
            Sleep, 200
            Send ^c
            Clip1 := Trim(Clipboard)
            Clip1 := RegExReplace(Clip1, "[^\d]") ; 숫자 이외의 문자 제거
            Sleep, 200
            MouseMove, 1315, 373
            Click 2
            Sleep, 200
            Send ^c
            Sleep, 200
            Send ^c
            Clip2 := Trim(Clipboard)
            Clip2 := RegExReplace(Clip2, "[^\d]") ; 숫자 이외의 문자 제거
            Sleep, 200

            ; 명시적으로 숫자로 변환합니다. 변환 실패 시 0으로 처리하여 오류 방지
            NumClip1 := Clip1 + 0
            NumClip2 := Clip2 + 0

            if ((NumClip1 - NumClip2) < 1) {
                if (NumClip2 != 0) {
                    MouseMove, 123, 372
                    Click
                    Sleep, 500
                    MouseMove, 1739, 175
                    Click
                    Sleep, 200
                    MouseMove, 1059, 164
                    Click
                    Sleep, 200
                    Sleep, 1500
                    Send {Enter}
                    Sleep, 200
                }
            }

            ; 2. 나머지 13개 항목을 레거시 Loop, Parse와 함수 호출로 처리
            Loop, Parse, CarCoordString, `, ; 쉼표로 각 CopyY 값을 분리
            {
                CopyY := A_LoopField ; A_LoopField가 곧 CopyY 값입니다.
                CheckAndSubmit(CopyY)
            }

            Clipboard := ClipSaved ; 클립보드 내용 복원
        }
    }
    else
    {
        MsgBox, , , 대상 창 (HYUNDAI MOBIS Agent Inventory Management System - Chrome)이 열려있지 않습니다. 먼저 창을 열어주세요., 2
        return
    }
}

; 모든 검증 통과 후 작업 시작 및 플래그 변경
IsProcessRunning := 1
if (Chk1)
    MsgBox, , , 직입고 입력 관리 종료됨!
else if (Chk2)
    MsgBox, , , 차량 입력 관리 종료됨!

return

ExitApp:
ExitApp
